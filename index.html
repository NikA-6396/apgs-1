<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>APG Store Pro</title>
    <style>
        :root { --bg: #f4f7f6; --card: #ffffff; --text: #2d3436; --primary: #27ae60; --dark: #1e8449; }
        [data-theme="dark"] { --bg: #121212; --card: #1e1e1e; --text: #ecf0f1; }
        
        body { font-family: -apple-system, sans-serif; margin: 0; padding-bottom: 100px; background: var(--bg); color: var(--text); }
        header { background: var(--dark); color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; }
        
        .search-container { padding: 15px; max-width: 600px; margin: 0 auto; }
        #searchInput { width: 100%; padding: 12px 20px; border-radius: 25px; border: 1.5px solid #ddd; outline: none; box-sizing: border-box; }

        .container { max-width: 1100px; margin: 0 auto; display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 15px; padding: 10px; }
        .card { background: var(--card); border-radius: 15px; padding: 12px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.05); border: 1px solid rgba(0,0,0,0.05); }
        .card img { width: 100%; height: 140px; object-fit: contain; }
        
        .qty-controls { display: flex; align-items: center; justify-content: center; gap: 10px; margin: 10px 0; }
        .qty-btn { background: #eee; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-weight: bold; }
        .add-btn { background: var(--primary); color: white; border: none; padding: 10px; width: 100%; border-radius: 10px; font-weight: bold; cursor: pointer; }

        #cart-bar { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; background: var(--dark); color: white; padding: 12px 20px; border-radius: 30px; display: none; justify-content: space-between; align-items: center; z-index: 1001; box-shadow: 0 10px 25px rgba(0,0,0,0.3); }

        /* Modal / Review Fixes */
        .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index: 2000; overflow-y: auto; }
        .modal-content { background: var(--card); width: 92%; max-width: 450px; margin: 20px auto; padding: 20px; border-radius: 20px; box-sizing: border-box; position: relative; }
        
        /* New Close Button */
        .close-modal-btn { position: absolute; top: 15px; right: 15px; background: #eee; border: none; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; font-size: 1.2rem; font-weight: bold; color: #333; z-index: 10; display: flex; align-items: center; justify-content: center; }

        .item-row { display: flex; align-items: center; gap: 10px; padding: 10px; background: rgba(0,0,0,0.03); border-radius: 12px; margin-bottom: 10px; }
        .item-info { flex: 1; }
        .item-info div { font-weight: bold; font-size: 0.9rem; }

        input, textarea { width: 100%; padding: 12px; margin: 8px 0; background: var(--bg); color: var(--text); border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; font-size: 16px; }
        .pay-opt { display: flex; gap: 8px; margin: 10px 0; }
        .pay-btn { flex: 1; padding: 12px; border: 2px solid #ddd; border-radius: 10px; text-align: center; cursor: pointer; font-weight: bold; }
        .pay-btn.active { border-color: var(--primary); background: rgba(39,174,96,0.1); color: var(--primary); }

        #finalBtn { width: 100%; padding: 15px; border: none; border-radius: 12px; background: #ccc; color: white; font-weight: bold; margin-top: 10px; cursor: pointer; }
    </style>
</head>
<body>

<header>
    <div style="font-weight: bold; font-size: 1.2rem;">ðŸš€ APG STORE</div>
    <button onclick="toggleTheme()" style="background:none; border:1px solid white; color:white; border-radius:8px; padding:5px 10px;">ðŸŒ“</button>
</header>

<div class="search-container">
    <input type="text" id="searchInput" placeholder="Search (Scale, Battery...)" onkeyup="searchProducts()">
</div>

<div class="container" id="product-list"></div>

<div id="cart-bar">
    <span id="cart-text">0 Items</span>
    <button onclick="openModal()" style="background:white; color:var(--dark); border:none; padding:8px 15px; border-radius:20px; font-weight:bold;">Review Order</button>
</div>

<div id="modal" class="modal">
    <div class="modal-content">
        <button class="close-modal-btn" onclick="closeModal()">Ã—</button>
        <h3 style="margin-top:0;">ðŸ›’ Order Details</h3>
        
        <div id="summary-list"></div>
        <div id="total-bill" style="text-align: right; font-weight: bold; font-size: 1.2rem; color: var(--primary); margin: 15px 0;"></div>
        
        <input type="text" id="custName" placeholder="Aapka Naam" oninput="validateForm()">
        <input type="tel" id="custPhone" placeholder="WhatsApp No." oninput="validateForm()">
        <textarea id="custAddress" rows="3" placeholder="Fetching Location..." oninput="validateForm()"></textarea>
        
        <div class="pay-opt">
            <div class="pay-btn" id="cod-opt" onclick="setPayment('COD')">COD</div>
            <div class="pay-btn" id="qr-opt" onclick="setPayment('QR')">Online QR</div>
        </div>

        <div id="qr-section" style="display:none; text-align:center; border:2px dashed var(--primary); padding:10px; border-radius:15px; margin-bottom: 10px;">
            <p style="font-size:0.8rem; margin:5px 0;">Pay â‚¹<span id="qr-amount"></span></p>
            <img id="qr-img" src="" style="width:140px;">
            <div style="font-size:0.8rem; margin-top:5px;"><input type="checkbox" id="payCheck" onchange="validateForm()"> I have Paid</div>
        </div>

        <button onclick="submitOrder()" id="finalBtn" disabled>Order via WhatsApp</button>
    </div>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyFo-gBoP2zOuYYTufx88ISyN4CegoF3lYQNTw4P9txkjcK_fRnd0s4Mlhv5dK9oRbb/exec";
    const MY_PHONE = "916396778097";
    const UPI_ID = "adhikarinikhil02@oksbi";
    
    let cart = [], paymentMethod = "";

    const products = [
        { id: 'p1', name: 'Digital Counter (30kg)', price: 3250, img: 'images/1.png' },
        { id: 'p2', name: 'Platform Scale (100kg)', price: 5800, img: 'images/2.png' },
        { id: 'p3', name: 'Battery (6V 5Ah)', price: 550, img: 'images/3.png' },
        { id: 'p4', name: 'Note Counter', price: 8200, img: 'images/4.png' },
        { id: 'p5', name: 'Sealer Machine', price: 1200, img: 'images/5.png' }
    ];

    function renderProducts(filter = "") {
        const list = document.getElementById('product-list');
        list.innerHTML = "";
        products.filter(p => p.name.toLowerCase().includes(filter.toLowerCase())).forEach(p => {
            list.innerHTML += `<div class="card">
                <img src="${p.img}">
                <div style="font-weight:bold; font-size:0.9rem; margin:5px 0;">${p.name}</div>
                <div style="color:var(--primary); font-weight:bold; margin-bottom:10px;">â‚¹${p.price}</div>
                <div class="qty-controls">
                    <button class="qty-btn" onclick="updateMainQty('${p.id}', -1)">-</button>
                    <span id="${p.id}">1</span>
                    <button class="qty-btn" onclick="updateMainQty('${p.id}', 1)">+</button>
                </div>
                <button class="add-btn" onclick="addToCart('${p.id}')">Add To Cart</button>
            </div>`;
        });
    }

    function updateMainQty(id, chg) {
        let el = document.getElementById(id), v = parseInt(el.innerText) + chg;
        if (v >= 1) el.innerText = v;
    }

    function addToCart(pid) {
        const p = products.find(i => i.id === pid);
        const qty = parseInt(document.getElementById(pid).innerText);
        const existing = cart.find(i => i.id === pid);
        if(existing) existing.qty += qty;
        else cart.push({...p, qty: qty});
        updateCartBar();
    }

    function updateCartBar() {
        const bar = document.getElementById('cart-bar');
        bar.style.display = cart.length > 0 ? 'flex' : 'none';
        document.getElementById('cart-text').innerText = cart.length + " Item(s) in Cart";
    }

    function searchProducts() { renderProducts(document.getElementById('searchInput').value); }

    function editCartQty(index, chg) {
        cart[index].qty += chg;
        if(cart[index].qty < 1) cart.splice(index, 1);
        updateCartBar();
        openModal();
    }

    function openModal() {
        document.getElementById('modal').style.display = 'block';
        let html = "", total = 0;
        cart.forEach((item, idx) => {
            let itemTotal = item.price * item.qty;
            total += itemTotal;
            html += `<div class="item-row">
                <img src="${item.img}" style="width:40px; height:40px; object-fit:contain; background:white;">
                <div class="item-info">
                    <div>${item.name}</div>
                    <small>â‚¹${item.price} x ${item.qty}</small>
                </div>
                <div style="display:flex; align-items:center; gap:8px;">
                    <button class="qty-btn" onclick="editCartQty(${idx}, -1)">-</button>
                    <span>${item.qty}</span>
                    <button class="qty-btn" onclick="editCartQty(${idx}, 1)">+</button>
                </div>
            </div>`;
        });
        document.getElementById('summary-list').innerHTML = html || "Empty";
        document.getElementById('total-bill').innerText = "Total: â‚¹" + total;
        fetchLocation();
        validateForm();
    }

    function fetchLocation() {
        if (navigator.geolocation && !document.getElementById('custAddress').value) {
            navigator.geolocation.getCurrentPosition(async (pos) => {
                const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${pos.coords.latitude}&lon=${pos.coords.longitude}`);
                const d = await res.json();
                document.getElementById('custAddress').value = d.display_name;
                validateForm();
            }, null);
        }
    }

    function setPayment(m) {
        paymentMethod = m;
        document.getElementById('cod-opt').className = 'pay-btn ' + (m==='COD'?'active':'');
        document.getElementById('qr-opt').className = 'pay-btn ' + (m==='QR'?'active':'');
        if(m==='QR') {
            let t = cart.reduce((s,i)=>s+(i.price*i.qty), 0);
            document.getElementById('qr-section').style.display = 'block';
            document.getElementById('qr-amount').innerText = t;
            document.getElementById('qr-img').src = `https://api.qrserver.com/v1/create-qr-code/?size=140x140&data=${encodeURIComponent('upi://pay?pa='+UPI_ID+'&am='+t+'&cu=INR')}`;
        } else document.getElementById('qr-section').style.display='none';
        validateForm();
    }

    function validateForm() {
        const n = document.getElementById('custName').value, p = document.getElementById('custPhone').value, a = document.getElementById('custAddress').value, btn = document.getElementById('finalBtn');
        const qC = document.getElementById('payCheck').checked;
        let v = n && p.length>=10 && a && paymentMethod && cart.length > 0;
        if(paymentMethod==='QR' && !qC) v = false;
        btn.disabled = !v; btn.style.background = v ? "var(--primary)" : "#ccc";
    }

    async function submitOrder() {
        const btn = document.getElementById('finalBtn');
        btn.innerText = "Processing..."; btn.disabled = true;
        const oid = "APG-" + Date.now().toString().slice(-5);
        let t = cart.reduce((s,i)=>s+(i.price*i.qty), 0);
        const data = { oid, name: document.getElementById('custName').value, phone: document.getElementById('custPhone').value, items: cart.map(i=>`${i.name}(x${i.qty})`).join(", "), total: "â‚¹"+t, payment: paymentMethod, address: document.getElementById('custAddress').value };

        try { await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(data) }); } catch (e) {}
        
        let msg = `*Order ID: ${oid}*\n*Name:* ${data.name}\n*Items:* \n${cart.map(i=>`- ${i.name} (x${i.qty})`).join("\n")}\n*Total:* â‚¹${t}\n*Payment:* ${paymentMethod}\n*Address:* ${data.address}`;
        window.open(`https://wa.me/${MY_PHONE}?text=${encodeURIComponent(msg)}`, '_blank');
        location.reload();
    }

    function toggleTheme() { document.body.setAttribute('data-theme', document.body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark'); }
    function closeModal() { document.getElementById('modal').style.display = 'none'; }
    
    renderProducts();
</script>
</body>
</html>
